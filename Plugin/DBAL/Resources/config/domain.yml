services:
    _defaults:
        autowire: true
        autoconfigure: true
        bind:
            string $tokensTable: "%apisearch_plugin.dbal.tokens_table%"
            string $configsTable: "%apisearch_plugin.dbal.index_configs_table%"
            string $usageLinesTable: "%apisearch_plugin.dbal.usage_lines_table%"
            string $metadataTable: "%apisearch_plugin.dbal.metadata_table%"
            bool $locatorEnabled: "%apisearch_plugin.dbal.locator_enabled%"
            int $loopPushInterval: "%apisearch_plugin.dbal.loop_push_interval%"
            $persistentUsageRepository: '@Apisearch\Plugin\DBAL\Domain\UsageRepository\DBALUsageRepository'

    Apisearch\Plugin\DBAL\Domain\:
        resource: '../../Domain/'

    Apisearch\Plugin\DBAL\Domain\Middleware\CheckHealthMiddleware:
        tags: ["apisearch_plugin.middleware"]

    #
    # Token Repository
    #
    Apisearch\Server\Domain\Repository\AppRepository\TokenRepository:
        class: Apisearch\Plugin\DBAL\Domain\AppRepository\DBALTokenRepository
        tags:
            - "apisearch_server.token_locator"
            - "apisearch_server.token_provider"

    Apisearch\Plugin\DBAL\Domain\AppRepository\DBALTokenRepository:
        alias: Apisearch\Server\Domain\Repository\AppRepository\TokenRepository

    #
    # Config Repository
    #
    Apisearch\Server\Domain\Repository\AppRepository\ConfigRepository:
        class: Apisearch\Plugin\DBAL\Domain\AppRepository\DBALConfigRepository

    Apisearch\Plugin\DBAL\Domain\AppRepository\DBALConfigRepository:
        alias: Apisearch\Server\Domain\Repository\AppRepository\ConfigRepository

    #
    # Usage Repository
    #
    Apisearch\Plugin\DBAL\Domain\UsageRepository\DBALUsageRepository:
    Apisearch\Plugin\DBAL\Domain\UsageRepository\ChunkUsageRepository:
    Apisearch\Server\Domain\Repository\UsageRepository\UsageRepository:
        alias: Apisearch\Plugin\DBAL\Domain\UsageRepository\ChunkUsageRepository

    #
    # Metadata Repository
    #
    Apisearch\Plugin\DBAL\Domain\MetadataRepository\DBALMetadataRepository:
    Apisearch\Server\Domain\Repository\MetadataRepository\MetadataRepository:
        alias: Apisearch\Plugin\DBAL\Domain\MetadataRepository\DBALMetadataRepository